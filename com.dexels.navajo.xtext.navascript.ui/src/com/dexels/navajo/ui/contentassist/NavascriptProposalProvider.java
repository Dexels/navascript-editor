/*
 * generated by Xtext 2.24.0
 */
package com.dexels.navajo.ui.contentassist;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;

import org.eclipse.emf.ecore.EObject;
import org.eclipse.jface.text.contentassist.ICompletionProposal;
import org.eclipse.jface.viewers.StyledString;
import org.eclipse.xtext.Assignment;
import org.eclipse.xtext.Keyword;
import org.eclipse.xtext.RuleCall;
import org.eclipse.xtext.ui.editor.contentassist.ContentAssistContext;
import org.eclipse.xtext.ui.editor.contentassist.ICompletionProposalAcceptor;
import org.osgi.framework.BundleContext;
import org.osgi.framework.ServiceEvent;
import org.osgi.framework.ServiceListener;
import org.osgi.framework.ServiceReference;

import com.dexels.navajo.mapping.compiler.meta.MapDefinition;
import com.dexels.navajo.mapping.compiler.meta.MethodDefinition;
import com.dexels.navajo.mapping.compiler.meta.ParameterDefinition;
import com.dexels.navajo.mapping.compiler.meta.ValueDefinition;
import com.dexels.navajo.navascript.KeyValueArgument;
import com.dexels.navajo.navascript.impl.AdapterMethodImpl;
import com.dexels.navajo.navascript.impl.FunctionIdentifierImpl;
import com.dexels.navajo.navascript.impl.KeyValueArgumentsImpl;
import com.dexels.navajo.navascript.impl.MapImpl;
import com.dexels.navajo.navascript.impl.MappedArrayFieldImpl;
import com.dexels.navajo.navigation.NavigationUtils;
import com.dexels.navajo.xtext.navascript.navajobridge.AdapterClassDefinition;
import com.dexels.navajo.xtext.navascript.navajobridge.NavajoProxyStub;
import com.dexels.navajo.xtext.navascript.navajobridge.OSGIRuntime;
import com.dexels.navajo.xtext.navascript.navajobridge.ProxyMapDefinition;
import com.dexels.navajo.xtext.navascript.navajobridge.ProxyMethodDefinition;
import com.dexels.navajo.xtext.navascript.navajobridge.ProxyParameterDefinition;
import com.dexels.navajo.xtext.navascript.navajobridge.ProxyValueDefinition;

/**
 * See https://www.eclipse.org/Xtext/documentation/310_eclipse_support.html#content-assist
 * on how to customize the content assistant.
 */
public class NavascriptProposalProvider extends AbstractNavascriptProposalProvider implements ServiceListener {

	NavajoProxyStub adapters = null;
	BundleContext context;

	public NavascriptProposalProvider() {
		context = OSGIRuntime.getDefaultBundleContext();
		if ( context != null ) {
			context.addServiceListener(this);
		} else {
			System.err.println("No OSGI environment found");
		}
	}

	public synchronized void init() {
		if ( adapters == null ) {
			ServiceReference<NavajoProxyStub> ref = context.getServiceReference(NavajoProxyStub.class);
			adapters = context.getService(ref);
			//adapters = NavajoProxyStub.getInstance();
		}
	}

	private NavajoProxyStub getNavajoProxyStub() {
		init();
		return adapters;
	}
	
	protected ICompletionProposal createCompletionProposalFormatted(String proposal, String extra, int priority, ContentAssistContext contentAssistContext) {


		StyledString displayText = ( extra != null ? 
				new StyledString(proposal).append(" - " + extra, ( priority > 1 ? StyledString.DECORATIONS_STYLER : StyledString.QUALIFIER_STYLER) ) : null);

		return createCompletionProposal(proposal, displayText, null, priority, contentAssistContext.getPrefix(), contentAssistContext);
	}

	@Override
	public void completeKeyword(Keyword keyword, ContentAssistContext contentAssistContext,
			ICompletionProposalAcceptor acceptor) {
		//System.err.println("In completeKeyword");
	}

	private void processKeyValueArguments(EObject model, RuleCall ruleCall, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		if ( model instanceof KeyValueArgumentsImpl ) {
			// Get parent
			KeyValueArgumentsImpl kvai = (KeyValueArgumentsImpl) model;
			EObject parent = context.getCurrentNode().getParent().getSemanticElement();
			EObject map = NavigationUtils.findFirstMapOrMappedField(context.getLastCompleteNode(), 0);
			if ( parent instanceof AdapterMethodImpl ) {
				AdapterMethodImpl method = (AdapterMethodImpl) parent;
				Set<String> currentParameters = new HashSet<>();
				for ( KeyValueArgument arg : kvai.getKeyValueArguments()) {
					currentParameters.add(arg.getKey());
				}
				createParameterList(context, acceptor, map, method, currentParameters);
			} else {
				System.err.println(">>>>>>>>>>>>>> Parent is: " + parent);
			}
		} else if ( model instanceof AdapterMethodImpl ) {
			AdapterMethodImpl method = (AdapterMethodImpl) model;
			EObject map = NavigationUtils.findFirstMapOrMappedField(context.getLastCompleteNode(), 0);
			createParameterList(context, acceptor, map, method, null);
		} else if ( model instanceof MapImpl ) {
			MapImpl map = (MapImpl) model;
			ProxyMapDefinition md = getNavajoProxyStub().getAdapter(map.getAdapterName()).getMapDefinition();
			Set<String> values = new TreeSet<>(md.getValueDefinitions());
			for ( String value : values) {
				ProxyValueDefinition vd = md.getValueDefinition(value);
				System.err.println("vd: " + vd.getName() + "/" + vd.getRequired());
				if ( vd != null && ( vd.getRequired() == null || !"automatic".equals(vd.getRequired()))) {
					acceptor.accept(createCompletionProposalFormatted(vd.getName() + "=", vd.getMapType(), 1, context));
				}
			}
		}
	}

	private void createParameterList(ContentAssistContext context, ICompletionProposalAcceptor acceptor, EObject map,
			AdapterMethodImpl method, Set<String> currentParameters) {

		String adapterName = "";
		if ( map instanceof MapImpl ) {
			adapterName = ((MapImpl) map).getAdapterName();
		} else if ( map instanceof MappedArrayFieldImpl ) { // It's a mapped field. Find it
			MappedArrayFieldImpl maf = (MappedArrayFieldImpl) map;
			String field = maf.getField();

		}
		AdapterClassDefinition md = getNavajoProxyStub().getAdapter(adapterName);
		ProxyMethodDefinition mdm = md.getMapDefinition().getMethodDefinition(method.getMethod().substring(1));
		Set<String> parameters = new TreeSet<>( mdm.getParameters() );
		if ( currentParameters == null ) {
			currentParameters =  new HashSet<>();
		}
		for ( String param : parameters ) { // First add all required params
			ProxyParameterDefinition vd = mdm.getParameterDefinition(param);
			if ( vd != null && !currentParameters.contains(param) && "true".equals(vd.getRequired())) {
				currentParameters.add(param);
				String type = "unknown";
				try {
					type = md.getType(vd.getField());
				} catch (Exception e) {
					System.err.println("Could not determine type for parameter: " + param);
				}
				System.err.println("Adding required param: " + param);
				acceptor.accept(createCompletionProposalFormatted(param + "=", type + " [" + vd.getRequired() + "]", 10, context));
			}
		}
		for ( String param : parameters ) {
			ProxyParameterDefinition vd = mdm.getParameterDefinition(param);
			if (  vd != null && !currentParameters.contains(param) && ( vd.getRequired() == null || !"automatic".equals(vd.getRequired()))) {
				String type = "unknown";
				try {
					type = md.getType(vd.getField());
				} catch (Exception e) {
					System.err.println("Could not determine type for parameter: " + param);
				}
				System.err.println("Adding NON required param: " + param);
				acceptor.accept(createCompletionProposalFormatted(param + "=", type, 1, context));
			}
		}
	}

	@Override
	public void complete_KeyValueArguments(EObject model, RuleCall ruleCall, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		System.err.println("In complete_KeyValueArguments");
		System.err.println("model: " + model);
		System.err.println("RuleCall: " + ruleCall);
		processKeyValueArguments(model, ruleCall, context, acceptor);
	}

	public void complete_KeyValueArgument(EObject model, RuleCall ruleCall, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		processKeyValueArguments(model, ruleCall, context, acceptor);
	}

	/**
	 * For the construction inside inner body
	 * {
	 *     $[setterfield] = [somevalue];
	 * }
	 * 
	 * The available setterfield values should be found in nearest map (either from MapImpl or from MappedArrayFieldImpl)
	 */
	@Override
	public void completeSetterField_Field(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {

		EObject map = NavigationUtils.findFirstMapOrMappedField(context.getLastCompleteNode(), 0);

		System.err.println("Found adapter: " + map + ", assignment: " + assignment);

		if ( map != null ) {
			String adapterName;
			Set<String> fields;
			if ( map instanceof MapImpl ) {
				adapterName = ((MapImpl) map).getAdapterName();
				AdapterClassDefinition md = getNavajoProxyStub().getAdapter(adapterName);
				fields = md.getSetters();
				for ( String a : fields ) {
					String type = "unknown";
					try {
						type = md.getType(a);
					} catch (Exception e) {
						System.err.println("Could not determine type for field: " + a);
					}
					System.err.println(a + " has type " + type);
					acceptor.accept(createCompletionProposalFormatted("$" + a, type, 1, context));
				}
			} else if ( map instanceof MappedArrayFieldImpl ) {
				System.err.println("Closest map is a MappedArrayFieldImpl");
			}
		}
	}

	/**
	 * For the construction of a "method" inside an adapter.
	 * Shows list of available method names based on  nearest map.
	 * 
	 * map.[someadapter]  {
	 * 
	 *   .[method]([arguments]);
	 *   
	 * }
	 */
	@Override
	public void completeAdapterMethod_Method(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {


		EObject map = NavigationUtils.findFirstMapOrMappedField(context.getLastCompleteNode(), 0);
		if ( map != null ) {
			String adapterName = null;
			if ( map instanceof MapImpl ) {
				adapterName = ((MapImpl) map).getAdapterName();
			} else {
				// Methods are not supported in MappedArrayField
				return;
			}
			Set<ProxyMethodDefinition> methods = getNavajoProxyStub().getAdapter(adapterName).getMethods();
			ProxyMapDefinition md = getNavajoProxyStub().getAdapter(adapterName).getMapDefinition();
			System.err.println(adapterName + " -> " + md);
			for ( ProxyMethodDefinition a : methods) {
				Set<String> parameters = a.getParameters();
				acceptor.accept(createCompletionProposalFormatted("." + a.getName(), parameters+"", 1, context));
			}
		} else {
			System.err.println("No parent map found");
		}
	}

	@Override
	public void completeMap_AdapterName(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {

		String [] list =  getNavajoProxyStub().getAdapters();

		System.err.println("list = " + list);

		for ( String a : list) {
			if ( getNavajoProxyStub().getAdapter(a) != null ) {
				ProxyMapDefinition md = getNavajoProxyStub().getAdapter(a).getMapDefinition();
				String description = ( md.description != null ? md.description.replaceAll("\n", "") : null);
				acceptor.accept(createCompletionProposalFormatted(md.tagName, description, 1, context));
			} else {
				acceptor.accept(createCompletionProposalFormatted(a, "-", 1, context));
			}
		}
	}

	/**
	 * For the construction of a mappabled field inside an expression.
	 * 
	 * ... = $[mappable_field] ... [expression]
	 * 
	 */
	@Override
	public void completeMappableIdentifier_Field(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {

		String prefix = NavigationUtils.getParentPrefix(context.getPrefix(), new StringBuffer());
		int level = NavigationUtils.countMappableParentLevel(prefix);

		EObject map = NavigationUtils.findFirstMapOrMappedField(context.getLastCompleteNode(), level);
		if ( map != null ) {
			AdapterClassDefinition md = NavigationUtils.findAdapterClass(getNavajoProxyStub(), map);
			if ( md != null ) {
				System.err.println("In completeMappableIdentifier_Field. adapter: " + md);
				Set<String> fields = md.getGetters();
				System.err.println("In completeMappableIdentifier_Field: " + fields);
				for ( String a : fields ) {
					List<List<String>> type = new ArrayList<>();
					try {
						type = md.getGetterTypeSignatures(a);
					} catch (Exception e) {
						System.err.println("Could not determine type for field: " + a);
					}
					System.err.println(a + " has type " + type);
					acceptor.accept(createCompletionProposalFormatted(prefix + a, ( type != null ? type.toString() : ""), 1, context));
				}
			} else {
				System.err.println("Could not find parent adapter for " + model);
			}
		}
	}

	/**
	 * For the construction of a mapped field 
	 * 
	 * [/My/Array] {
	 *   $[mapped_field]  {
	 *   
	 *   }
	 * }
	 */
	@Override
	public void completeMappedArrayField_Field(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {

		System.err.println("In completeMappedArrayField_Field!!!!!");

		String prefix = NavigationUtils.getParentPrefix(context.getPrefix(), new StringBuffer());
		System.err.println("Prefix is: " + prefix);
		int level = NavigationUtils.countMappableParentLevel(prefix);

		EObject map = NavigationUtils.findFirstMapOrMappedField(context.getLastCompleteNode(), level);
		System.err.println("In completeMappedArrayField_Field.findFirstMapOrMappedField() map: " + map);

		if ( map != null ) {
			AdapterClassDefinition md = NavigationUtils.findAdapterClass(getNavajoProxyStub(), map);
			if ( md != null ) {
				System.err.println("Found AdapterClassDefinition: " + md.getObjectName());
				List<ProxyValueDefinition> valuedDefs = md.getDeclaredValues();
				System.err.println("In completeMappedArrayField_Field: " + valuedDefs);
				for ( ProxyValueDefinition a : valuedDefs ) {
					System.err.println("ValueDefinition " + a.getName() + " [" + a.getMap() + "]");
					if ( a.getMap() != null && !"".equals(a.getMap() )) {
						acceptor.accept(createCompletionProposalFormatted(prefix + a.getName(), a.getMapType(), 10, context));
					}
				}
			} else {
				System.err.println("Could not findAdapterClass for map: " + map);
			}
		}
	}


	@Override
	public void completeFunctionIdentifier_Func(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {
		String [] functions = getNavajoProxyStub().getFunctions();
		for ( String a : functions ) {
			String description = "";
			try {
				description = getNavajoProxyStub().getFunction(a).getDescription();
			} catch (Exception e) {
				System.err.println("Could not determine type for field: " + a);
			}
			acceptor.accept(createCompletionProposalFormatted( a + "(", description, 1, context));
		}
	}

	@Override
	public void completeFunctionIdentifier_Args(EObject model, Assignment assignment, ContentAssistContext context, ICompletionProposalAcceptor acceptor) {

		if ( model instanceof FunctionIdentifierImpl ) {

			FunctionIdentifierImpl fil = (FunctionIdentifierImpl) model;


			String[][] altInputs = getNavajoProxyStub().getFunction(fil.getFunc()).getInputParams();
			for ( String [] alt : altInputs ) {
				StringBuffer sb = new StringBuffer();
				for ( String input : alt ) {
					sb.append(input);
					sb.append(",");
				}
				acceptor.accept(createCompletionProposalFormatted( "", sb.toString(), 10, context));
			}

		}
	}

	@Override
	public void serviceChanged(ServiceEvent arg0) {
		init();
	}

}
